@page "/patient/{patientId:int}"
@using DottoressaIorio.App.Models
@using DottoressaIorio.App.Services
@using DottoressaIorio.App.Data
@inject ApplicationDbContext dbContext
@inject NavigationManager navigationManager
@inject IJSRuntime jsRuntime
@inject PdfService pdfService

<PageTitle>Patient Details</PageTitle>
<h1>@patient.Title @patient.FirstName @patient.LastName</h1>

@if (patient == null)
{
    <p>Invalid patient ID or patient not found.</p>
}
else
{
    <div>
        <p>
            <strong>Data di Nascita:</strong> @patient.DateOfBirth?.ToShortDateString()
        </p>
        <p>
            <strong>Email:</strong> <a href="mailto:@patient.Email">@patient.Email</a>
        </p>
        @if (@patient.PlaceOfBirth != null)
        {
            <p>
                <strong>Luogo di Nascita:</strong> @patient.PlaceOfBirth
            </p>
        }
        @if (@patient.Gender != null)
        {
            <p>
                <strong>Sesso:</strong> @patient.Gender
            </p>
        }
        @if (@patient.PhoneNumber != null)
        {
            <p>
                <strong>Numero di telefono:</strong> <a href="tel:@patient.PhoneNumber">@patient.PhoneNumber</a>
            </p>
        }
    </div>

    <h3>Therapies</h3>

    <a class="btn btn-primary" href="/patients/edit/@PatientId/therapies/create">Create Therapy</a>
    @if (therapies != null && therapies.Any())
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Therapy Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in therapies)
                {
                    <tr>
                        <td>
                            <a href="/therapies/edit/@t.TherapyId">
                                @t.CreatedDate.ToString("dd/MM/yyyy")
                            </a>
                        </td>
                        <td>
                            <button class="btn btn-primary" @onclick="() => NavigateToPrintTherapy(t.TherapyId)">Print</button>
                            <button class="btn btn-danger" @onclick="() => NavigateToDeleteTherapy(t.TherapyId)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private Patient patient;

    [Parameter] public int PatientId { get; set; }
    private List<Therapy> therapies;


    protected override void OnInitialized()
    {
        patient = dbContext.Patients.FirstOrDefault(x => x.PatientId == PatientId);
        therapies = dbContext.Therapies.Where(t => t.PatientId == PatientId).ToList();
    }

    private async Task NavigateToPrintTherapy(int id)
    {
        var therapy = dbContext.Therapies.FirstOrDefault(t => t.TherapyId == id);

        if (therapy != null)
        {
            var pdfBytes = pdfService.GenerateTherapyPdf(therapy);

            // Convert the PDF bytes to a Base64 string
            var pdfBase64 = Convert.ToBase64String(pdfBytes);

            var filename = $"{patient.FirstName}_{patient.LastName}_{therapy.CreatedDate:yy_MM_dd}_{DateTime.Now.ToFileTimeUtc()}.pdf";
            // Open the PDF in a new tab
            await jsRuntime.InvokeVoidAsync("jsSaveAsFile", filename, pdfBase64);
        }
    }

    private void NavigateToDeleteTherapy(int id)
    {
        navigationManager.NavigateTo($"/therapies/delete/{id}");
    }
}